---
title: "Homework 2"
author: "Gifty Osei"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    latex_engine: xelatex
header-includes:
  - \usepackage{pdfpages}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE,tidy = TRUE,dev = "cairo_pdf")

library(latex2exp)
```


## Acknowledgement / Disclosure Statement

I discussed this homework with Jacob Antici at some point specifically on understanding some of the problems/questions, however my work is completely independent. I also used Chat-GPT to fine tune my writings and occasionally in fixing bugs in my code.



## Part 1





```{r}

## small laptop path
#path <- "D:/WashU/PHD/Year 2/Sem 2/SDS 5320/Homework/PS2_data.txt" 

#  desktop path
path <- "F:/PHD/SDS 5320/Homework/PS2_data.txt"
df <- read.table(path, header = TRUE)

str(df)
table(df$pg)
table(df$i_aqoc)

## physician 1 vs physician 2

```


To define treatment, we convert categorical covariates; Let 

$Z=1$ if $\text{pg} == 1$ (physician group 1) and $Z=0$ if $\text{pg}== 2$

 - i_educ == 1: occurs once and only in one group
 
 - i_insu == 3: occurs once and only in one group
 
 Now to fit the propensity score first we stabilize these covariates;
 
```{r}

## Treatment + covariates


## convert to 0, 1 treatment, control groups
df$Z <- ifelse(df$pg == 1, 1, 0)

## Convert categorical variables to factors
df$i_sex  <- factor(df$i_sex)
df$i_race <- factor(df$i_race)
df$i_educ <- factor(df$i_educ)
df$i_insu <- factor(df$i_insu)
df$i_drug <- factor(df$i_drug)
df$i_seve <- factor(df$i_seve)
df$i_aqoc <- factor(df$i_aqoc)

## Collapse ultra-rare levels to avoid separation / non-convergence
## educ: move level "1" into "2"
df$i_educ <- as.character(df$i_educ)
df$i_educ[df$i_educ == "1"] <- "2"
df$i_educ <- factor(df$i_educ)

## insu: move level "3" into "2"
df$i_insu <- as.character(df$i_insu)
df$i_insu[df$i_insu == "3"] <- "2"
df$i_insu <- factor(df$i_insu)

## Check cross-tabs after collapsing (should remove zero cells)
table(df$i_educ, df$Z)
table(df$i_insu, df$Z)

```
 
```{r}

## Propensity score model
## di=o we add i_aqoc variable or not

ps_mod <- glm(
  Z ~ i_age + i_sex + i_race + i_educ + i_insu + i_drug + i_seve +
    com_t + pcs_sd + mcs_sd ,
  data = df,
  family = binomial()
)

summary(ps_mod)

## Predicted propensity score e_hat = P(Z=1 | X)
df$e_hat <- predict(ps_mod, type = "response")

summary(df$e_hat)
tapply(df$e_hat, df$Z, summary)

```

Some of the propensity scores are near 0 and 1 so we check weight extremes

We compute IPW (ATE) weights:

 - if Z = 1: $w_1(x_i) = \dfrac{1}{\hat{e}(x_i)}$
 
 - if Z = 0: $w_0(x_i) = \dfrac{1}{(1-\hat{e}(x_i))}$
 
```{r}

## IPW weights (ATE)

df$w_ipw <- ifelse(df$Z == 1, 1 / df$e_hat, 1 / (1 - df$e_hat))

summary(df$w_ipw)
quantile(df$w_ipw, probs = c(.9, .95, .99))

## Show the most extreme weights
df_extreme <- df[order(df$w_ipw, decreasing = TRUE),
                 c("pg","Z","i_aqoc","e_hat","w_ipw","i_race","i_educ","i_insu","i_seve",
                   "com_t","pcs_sd","mcs_sd")]
head(df_extreme, 10)

```
 
For Balance checking using ASD

$$\text{ASD} = \dfrac{|\frac{\sum_{i=1}^N w_1(X_i)Z_i X_{pi}}{\sum_{i=1}^N w_1(X_i)Z_i} - \frac{\sum_{i=1}^N w_0(X_i)(1-Z_i) X_{pi}}{\sum_{i=1}^N w_0(X_i)(1-Z_i)}|}{\sqrt{\frac{s_1^2 + s_0^2}{2}}}$$




For binary covariates, we use the proportions = $(p_1 + p_0)/2$


```{r}

## ASD functions

w_mean <- function(x, w) sum(w * x) / sum(w)
w_var  <- function(x, w) {
  m <- w_mean(x, w)
  sum(w * (x - m)^2) / sum(w)
}

asd_cont <- function(x, z, w1 = NULL, w0 = NULL) {
  if (is.null(w1)) w1 <- rep(1, length(x))
  if (is.null(w0)) w0 <- rep(1, length(x))
  x1 <- x[z == 1]; x0 <- x[z == 0]
  ww1 <- w1[z == 1]; ww0 <- w0[z == 0]
  m1 <- w_mean(x1, ww1); m0 <- w_mean(x0, ww0)
  v1 <- w_var(x1, ww1);  v0 <- w_var(x0, ww0)
  denom <- sqrt((v1 + v0) / 2)
  abs(m1 - m0) / denom
}

asd_bin <- function(xbin, z, w1 = NULL, w0 = NULL) {
  if (is.null(w1)) w1 <- rep(1, length(xbin))
  if (is.null(w0)) w0 <- rep(1, length(xbin))
  x1 <- xbin[z == 1]; x0 <- xbin[z == 0]
  ww1 <- w1[z == 1];  ww0 <- w0[z == 0]
  p1 <- w_mean(x1, ww1); p0 <- w_mean(x0, ww0)
  p <- (p1 + p0) / 2
  denom <- sqrt(p * (1 - p))
  abs(p1 - p0) / denom
}

asd_factor_max <- function(f, z, w1 = NULL, w0 = NULL) {
  levs <- levels(f)
  asds <- sapply(levs, function(L) {
    xbin <- as.integer(f == L)
    asd_bin(xbin, z, w1, w0)
  })
  max(asds, na.rm = TRUE)
}

```


For ASD before weighting vs after IPW;


```{r}
##  ASD table: unweighted vs IPW

z <- df$Z

## group-specific weights for balance computation
w1 <- 1 / df$e_hat
w0 <- 1 / (1 - df$e_hat)

out <- data.frame(
  covariate = c("i_age","com_t","pcs_sd","mcs_sd",
                "i_sex","i_race","i_educ","i_insu","i_drug","i_seve"),
  ASD_unweighted = NA_real_,
  ASD_IPW = NA_real_
)

## continuous
out[out$covariate=="i_age",  c("ASD_unweighted","ASD_IPW")]  <- c(asd_cont(df$i_age,  z),
                                                                 asd_cont(df$i_age,  z, w1, w0))
out[out$covariate=="com_t",  c("ASD_unweighted","ASD_IPW")]  <- c(asd_cont(df$com_t,  z),
                                                                 asd_cont(df$com_t,  z, w1, w0))
out[out$covariate=="pcs_sd", c("ASD_unweighted","ASD_IPW")]  <- c(asd_cont(df$pcs_sd, z),
                                                                 asd_cont(df$pcs_sd, z, w1, w0))
out[out$covariate=="mcs_sd", c("ASD_unweighted","ASD_IPW")]  <- c(asd_cont(df$mcs_sd, z),
                                                                 asd_cont(df$mcs_sd, z, w1, w0))

## categorical (max over levels)
out[out$covariate=="i_sex",  c("ASD_unweighted","ASD_IPW")]  <- c(asd_factor_max(df$i_sex,  z),
                                                                 asd_factor_max(df$i_sex,  z, w1, w0))
out[out$covariate=="i_race", c("ASD_unweighted","ASD_IPW")]  <- c(asd_factor_max(df$i_race, z),
                                                                 asd_factor_max(df$i_race, z, w1, w0))
out[out$covariate=="i_educ", c("ASD_unweighted","ASD_IPW")]  <- c(asd_factor_max(df$i_educ, z),
                                                                 asd_factor_max(df$i_educ, z, w1, w0))
out[out$covariate=="i_insu", c("ASD_unweighted","ASD_IPW")]  <- c(asd_factor_max(df$i_insu, z),
                                                                 asd_factor_max(df$i_insu, z, w1, w0))
out[out$covariate=="i_drug", c("ASD_unweighted","ASD_IPW")]  <- c(asd_factor_max(df$i_drug, z),
                                                                 asd_factor_max(df$i_drug, z, w1, w0))
out[out$covariate=="i_seve", c("ASD_unweighted","ASD_IPW")]  <- c(asd_factor_max(df$i_seve, z),
                                                                 asd_factor_max(df$i_seve, z, w1, w0))

out$ASD_unweighted <- round(out$ASD_unweighted, 3)
out$ASD_IPW        <- round(out$ASD_IPW, 3)

out[order(out$ASD_IPW, decreasing = TRUE), ]

```

**lets do the love plot here**

```{r}
# install.packages("cobalt")
library(cobalt)

# Covariate formula (same as your PS model)
f <- Z ~ i_age + i_sex + i_race + i_educ + i_insu + i_drug + i_seve + com_t + pcs_sd + mcs_sd

# Balance table for IPW (includes BOTH unadjusted + adjusted automatically)
bal_ipw <- bal.tab(
  f,
  data = df,
  weights = df$w_ipw,
  method = "weighting",
  estimand = "ATE",
  s.d.denom = "pooled"
)

print(bal_ipw)

# Love plot: Unweighted vs IPW
love.plot(
  bal_ipw,
  stat = "mean.diffs",     # ASD / standardized mean differences
  abs  = TRUE,
  thresholds = c(m = .1),  # ASD=0.1 reference line
  var.order = "unadjusted",
  line = TRUE
)


bal_ow <- bal.tab(
  f,
  data = df,
  weights = df$w_ow,
  method = "weighting",
  estimand = "ATO",
  s.d.denom = "pooled"
)

print(bal_ow)

love.plot(
  bal_ow,
  stat = "mean.diffs",
  abs  = TRUE,
  thresholds = c(m = .1),
  var.order = "unadjusted",
  line = TRUE
)


## Make sure treatment exists in df
df$Z <- ifelse(df$pg == 1, 1, 0)
table(df$Z)

## Balance object (IPW)
f <- Z ~ i_age + i_sex + i_race + i_educ + i_insu + i_drug + i_seve + com_t + pcs_sd + mcs_sd

bal_ipw <- bal.tab(
  f,
  data = df,
  weights = df$w_ipw,
  method = "weighting",
  estimand = "ATE",
  s.d.denom = "pooled"
)

## Love plot (USE bal_ipw, not df)
love.plot(
  bal_ipw,
  stat = "mean.diffs",
  abs = TRUE,
  thresholds = c(m = 0.1),
  var.order = "unadjusted",
  line = TRUE
)


X <- model.matrix(
  ~ i_age + i_sex + i_race + i_educ + i_insu + i_drug + i_seve + com_t + pcs_sd + mcs_sd,
  data = df
)[, -1, drop = FALSE]

bal_ipw2 <- bal.tab(
  X,
  treat = df$Z,
  weights = df$w_ipw,
  method = "weighting",
  estimand = "ATE",
  s.d.denom = "pooled"
)

love.plot(
  bal_ipw2,
  stat = "mean.diffs",
  abs = TRUE,
  thresholds = c(m = 0.1),
  var.order = "unadjusted",
  line = TRUE
)


```

**Comments**

We see that IPW drastically improves balance for most covariates. Race still remains poorly balanced and this because 1 race category has very limited overlap across physician groups. The threshold is 0.1



Overlap weighting (OW) which balances model covariates automatically

We now; $e(X) = P(Z =1 \mid X)$

 - If Z=1: $w^{OW} = 1 - e(X)$
 
 - If Z = 0: $w^{OW} = e(X)$



```{r}

## Overlap weights (OW)
df$w_ow <- ifelse(df$Z == 1, 1 - df$e_hat, df$e_hat)

z <- df$Z  # make sure this exists

## group-specific weights for ASD computation
w1_ow <- 1 - df$e_hat
w0_ow <- df$e_hat

## IMPORTANT: keep as data.frame
out_ow <- out[, "covariate", drop = FALSE]
out_ow$ASD_OW <- NA_real_

library(dplyr)

out_ow <- out %>%
  select(covariate) %>%
  mutate(ASD_OW = NA_real_)

## continuous
out_ow[out_ow$covariate=="i_age",  "ASD_OW"] <- asd_cont(df$i_age,  z, w1_ow, w0_ow)
out_ow[out_ow$covariate=="com_t",  "ASD_OW"] <- asd_cont(df$com_t,  z, w1_ow, w0_ow)
out_ow[out_ow$covariate=="pcs_sd", "ASD_OW"] <- asd_cont(df$pcs_sd, z, w1_ow, w0_ow)
out_ow[out_ow$covariate=="mcs_sd", "ASD_OW"] <- asd_cont(df$mcs_sd, z, w1_ow, w0_ow)

## categorical (max over levels)
out_ow[out_ow$covariate=="i_sex",  "ASD_OW"] <- asd_factor_max(df$i_sex,  z, w1_ow, w0_ow)
out_ow[out_ow$covariate=="i_race", "ASD_OW"] <- asd_factor_max(df$i_race, z, w1_ow, w0_ow)
out_ow[out_ow$covariate=="i_educ", "ASD_OW"] <- asd_factor_max(df$i_educ, z, w1_ow, w0_ow)
out_ow[out_ow$covariate=="i_insu", "ASD_OW"] <- asd_factor_max(df$i_insu, z, w1_ow, w0_ow)
out_ow[out_ow$covariate=="i_drug", "ASD_OW"] <- asd_factor_max(df$i_drug, z, w1_ow, w0_ow)
out_ow[out_ow$covariate=="i_seve", "ASD_OW"] <- asd_factor_max(df$i_seve, z, w1_ow, w0_ow)

out_ow$ASD_OW <- round(out_ow$ASD_OW, 3)
out_ow

```



For the weighted ATE under a user specified target population. Here outcome is i_aqoc

```{r}

## 7) ATE estimates (Hajek / normalized)

y <- df$i_aqoc

## IPW (ATE)
p1_ipw <- weighted.mean(y[df$Z==1], w = (1/df$e_hat)[df$Z==1])
p2_ipw <- weighted.mean(y[df$Z==0], w = (1/(1-df$e_hat))[df$Z==0])
Q_ipw  <- p1_ipw - p2_ipw

## OW (overlap population)
p1_ow <- weighted.mean(y[df$Z==1], w = (1-df$e_hat)[df$Z==1])
p2_ow <- weighted.mean(y[df$Z==0], w = (df$e_hat)[df$Z==0])
Q_ow  <- p1_ow - p2_ow

c(p1_ipw=p1_ipw, p2_ipw=p2_ipw, Q_ipw=Q_ipw,
  p1_ow=p1_ow,  p2_ow=p2_ow,  Q_ow=Q_ow)

```

**Comment**





